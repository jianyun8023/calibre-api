<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Search</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3.2.37/dist/vue.global.js"></script>
</head>
<body bg-gray-100>
<header class="bg-white py-4 shadow-md">
    <div class="container mx-auto text-center">
        <a class="text-2xl font-bold text-red-500 cursor-pointer" href="/">无名图书</a>
    </div>
</header>
<main class="container mx-auto mt-8 w-full md:w-2/3" id="app">
    <div class="flex justify-center mb-8">
        <input v-model="searchQuery" @input="fetchBooks" type="text" placeholder="书名, 作者, ISBN"
               class="w-1/2 px-4 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500">
    </div>
    <section>
        <h2 class="text-xl font-bold mb-4">搜索结果：<strong>{{ keyword }}</strong>  </h2>
        <div class="grid grid-cols-1 gap-4">
            <div v-for="book in books" :key="book.id" class="flex bg-white p-4 rounded-lg shadow-md"
                 @click="redirectToDetail(book.id)">
                <img :src="book.cover" alt="书籍封面" class="w-24 h-32 object-cover mr-4">
                <div class="w-full md:w-2/3">
                    <h3 class="text-lg font-semibold truncate">{{ book.title }}</h3>
                    <p class="text-gray-600 truncate" v-if="book.authors && book.authors.length">{{ book.authors.join(', ') }}</p>            </div>
                    <p class="text-gray-600">{{ book.publisher }}</p>
                    <p class="text-gray-600">{{ new Date(book.pubdate).toLocaleDateString() }}</p>
                </div>
            </div>
        </div>
    </section>
</main>
<footer class="bg-white py-4 shadow-md">
    <div class="container mx-auto text-center">
        <a href="/" class="text-blue-500">Home</a>
        <a href="/setting" class="text-blue-500">设置</a>
    </div>
</footer>
<script>
    const {createApp} = Vue;

    createApp({
        data() {
            return {
                searchQuery: '',
                keyword: '',
                publisher: '',
                author: '',
                books: [],
                filter: [],
            };
        },
        created() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('query')) {
                this.searchQuery = urlParams.get('query');
            }
            if (urlParams.has('publisher')) {
                this.publisher = urlParams.get('publisher');
            }
            if (urlParams.has('author')) {
                this.author = urlParams.get('author');
            }
        },
        watch: {
            searchQuery() {
                this.keyword = this.searchQuery;
                this.filter = [];
            },
            publisher(){
                this.keyword = this.publisher;
                this.filter[0] = "publisher = \"" + this.publisher + "\"";
            },
            author(){
                this.keyword = this.author;
                this.filter[0] = "authors = \"" + this.author + "\"";
            }
        },
        methods: {
            async fetchBooks() {
                const response = await fetch('/api/search?q=' + this.searchQuery, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        Filter: this.filter,
                        Limit: 12,
                    }),
                });
                const data = await response.json();
                this.books = data.hits;

                // Clear the query parameter from the URL
                const url = new URL(window.location);
                url.searchParams.delete('query');
                window.history.replaceState({}, '', url);
            },
            redirectToDetail(id) {
                window.location.href = `/detail/${id}`;
            },
            redirectToHome() {
                window.location.href = '/';
            },
        },
        mounted() {
            this.fetchBooks();
        },
    }).mount('#app');
</script>
</body>
</html>