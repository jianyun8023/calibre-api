<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3.2.37/dist/vue.global.js"></script>
</head>

<body class="bg-gray-100">
    <header class="bg-white py-4 mx-auto shadow-md">
        <div class="container mx-auto text-center">
            <a class="text-2xl font-bold text-red-500 cursor-pointer" href="/">Êó†ÂêçÂõæ‰π¶</a>
        </div>
    </header>
    <main id="app" class="container mx-auto mt-8 w-full md:w-2/3">
        <div class="flex justify-center mb-8">
            <input v-model="searchQuery" @keyup.enter="redirectToSearch" type="text" placeholder="‰π¶Âêç, ‰ΩúËÄÖ, ISBN"
                class="w-1/2 px-4 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500">
        </div>
        <section>
            <h2 class="text-2xl font-bold mb-4">{{ book.title }} </h2>
            <p class="text-gray-700 mb-2"><strong>ID:</strong> {{ book.id }}
                <button @click="copyToClipboard(book.id)" class="ml-2 text-blue-500">üìã</button>
            </p>
            <div v-if="book" class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex flex-col md:flex-row bg-fixed">
                    <img :src="book.cover" alt="Book Cover"
                        class="w-full md:w-1/3 object-cover rounded-lg mb-4 md:mb-0">
                    <div class="md:ml-6 items-stretch">
                        <p class="text-gray-700 mb-2 self-auto"><strong>Authors:</strong>
                            <span v-for="(author, index) in book.authors" :key="author" @click="searchByAuthor(author)"
                                :class="{'text-blue-600': index % 2 === 0, 'text-orange-600': index % 2 !== 0}"
                                class="cursor-pointer mr-2">{{ author }} </span>
                        </p>
                        <p class="text-gray-700 mb-2 self-auto"><strong class="font-mono">Publisher:</strong><span
                                @click="searchByPublisher" class="cursor-pointer text-blue-600">{{
                                book.publisher}}</span>
                        </p>
                        <p class="text-gray-700 mb-2 self-auto font-serif"><strong>ISBN:</strong> {{ book.isbn }}</p>
                        <p class="text-gray-700 mb-2 self-auto" font-serif><strong>Published Date:</strong>
                            {{ new Date(book.pubdate).toLocaleDateString() }}</p>
                        <p class="text-gray-700 mb-2 self-auto" font-serif><strong>Tags:</strong> {{ book.tags.join(',') }}</p>
                        <p class="text-gray-700 mb-2 self-auto" font-serif><strong>File Size:</strong> {{
                            formatFileSize(book.size) }}</p>
                        <a :href="book.file_path"
                            :class="{'bg-gray-500 cursor-not-allowed': !book.file_path, 'bg-blue-500': book.file_path}"
                            class="mt-4 inline-block text-white px-4 py-2 rounded-lg"
                            :disabled="!book.file_path">Download
                            Book</a>
                        <a @click="deleteBook(book.id)"
                            class="mt-4 inline-block text-gray-700 px-4 py-2">Delete Book</a>
                    </div>
                </div>

                <article v-if="book.comments" class="mt-8">
                    <h2 class="text-xl font-bold mb-4">ÁÆÄ‰ªã</h2>
                    <p class="text-gray-700 mb-2 font-serif  text-prett text-lg indent-8">{{ book.comments }}</p>
                </article>
            </div>
        </section>

    </main>
    <footer class="bg-white py-4 shadow-md mx-auto">
        <div class="container mx-auto text-center">
            <a href="/" class="text-blue-500 block sm:inline-block sm:mr-4">Home</a>
            <a href="/search" class="text-blue-500 block sm:inline-block">ÊêúÁ¥¢</a>
        </div>
    </footer>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    book: null,
                    searchQuery: '',
                };
            },
            created() {
                const urlParams = new URLSearchParams(window.location.search);
                const id = window.location.pathname.split('/').pop();
                this.fetchBook(id);
            },
            methods: {
                async fetchBook(id) {
                    try {
                        const response = await fetch(`/api/book/${id}`);
                        if (!response.ok) throw new Error('Network response was not ok');
                        this.book = await response.json();
                    } catch (error) {
                        console.error('There was a problem with the fetch operation:', error);
                    }
                },
                redirectToSearch() {
                    window.location.href = `/search?query=${encodeURIComponent(this.searchQuery)}`;
                },
                formatFileSize(size) {
                    if (size < 1024 * 1024) return (size / 1024).toFixed(2) + ' KB';
                    return (size / 1024 / 1024).toFixed(2) + ' MB';
                },
                copyToClipboard(text) {
                    navigator.clipboard.writeText(text).then(() => {
                        alert('ID copied to clipboard');
                    }).catch(err => {
                        console.error('Could not copy text: ', err);
                    });
                },
                searchByPublisher() {
                    window.location.href = `/search?publisher=${encodeURIComponent(this.book.publisher)}`;
                },
                searchByAuthor(author) {
                    window.location.href = `/search?author=${encodeURIComponent(author)}`;
                },
                redirectToHome() {
                    window.location.href = '/';
                },
                async deleteBook(bookId) {
            const url = `https://lib.pve.icu/cdb/delete-books/${bookId}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    alert('Book deleted successfully');
                    // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÖ∂‰ªñÈÄªËæëÔºå‰æãÂ¶ÇÂà∑Êñ∞È°µÈù¢ÊàñÊõ¥Êñ∞ËßÜÂõæ
                } else {
                    alert('Failed to delete book');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while deleting the book');
            }
        },
            },
        }).mount('#app');
    </script>
</body>

</html>